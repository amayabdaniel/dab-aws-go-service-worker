name: CD

on:
  push:
    branches: [master, main]

env:
  AWS_REGION: us-east-2
  ECR_REGISTRY: 018491521563.dkr.ecr.us-east-2.amazonaws.com
  ECS_CLUSTER: dab-job-platform-c1bfa7bb-cluster

jobs:
  terraform:
    name: Terraform Apply
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: infrastructure/terraform
    outputs:
      api_repo: ${{ steps.outputs.outputs.api_repo }}
      worker_repo: ${{ steps.outputs.outputs.worker_repo }}
      frontend_repo: ${{ steps.outputs.outputs.frontend_repo }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Tofu Init
        run: tofu init

      - name: Tofu Apply
        run: tofu apply -auto-approve
        env:
          TF_VAR_rds_password: ${{ secrets.TF_VAR_RDS_PASSWORD }}

      - name: Get Outputs
        id: outputs
        run: |
          echo "api_repo=$(tofu output -raw ecr_api_repository_url)" >> $GITHUB_OUTPUT
          echo "worker_repo=$(tofu output -raw ecr_worker_repository_url)" >> $GITHUB_OUTPUT
          echo "frontend_repo=$(tofu output -raw ecr_frontend_repository_url)" >> $GITHUB_OUTPUT

  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    needs: terraform
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push API
        uses: docker/build-push-action@v5
        with:
          context: .
          file: deployments/docker/api.Dockerfile
          push: true
          tags: |
            ${{ needs.terraform.outputs.api_repo }}:latest
            ${{ needs.terraform.outputs.api_repo }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Worker
        uses: docker/build-push-action@v5
        with:
          context: .
          file: deployments/docker/worker.Dockerfile
          push: true
          tags: |
            ${{ needs.terraform.outputs.worker_repo }}:latest
            ${{ needs.terraform.outputs.worker_repo }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: frontend
          file: frontend/Dockerfile
          push: true
          tags: |
            ${{ needs.terraform.outputs.frontend_repo }}:latest
            ${{ needs.terraform.outputs.frontend_repo }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to ECS
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy API service
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service dab-job-platform-c1bfa7bb-api \
            --force-new-deployment

      - name: Deploy Worker service
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service dab-job-platform-c1bfa7bb-worker \
            --force-new-deployment

      - name: Deploy Frontend service
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service dab-job-platform-c1bfa7bb-frontend \
            --force-new-deployment

      - name: Wait for services to stabilize
        run: |
          echo "Waiting for API service..."
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services dab-job-platform-c1bfa7bb-api

          echo "Waiting for Worker service..."
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services dab-job-platform-c1bfa7bb-worker

          echo "Waiting for Frontend service..."
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services dab-job-platform-c1bfa7bb-frontend

      - name: Health check
        run: |
          echo "Running health check..."
          curl -f https://app.novaferi.net/api/health || exit 1
          echo "Deployment successful!"
